#!/usr/bin/env python
# (c) Copyright 2023 Premier Heart, LLC

import json
import os
import sys

def print_results_summary(res, indent="\t"):
    print(indent + "Diagnosis generated by " + res['source'])
    print(indent + "MCG Category: %s" % res['category'])

    print_basic_results(res, indent)

    print_tracing_quality(res, indent)

def print_basic_results(res, indent):
    print(indent + "Conditions detected (positives):")
    for diag, score in res['positive'].items():
        print(indent + indent + "%s : %0.1f" % (diag, score))
        
    print(indent + "Conditions not detected (negatives):")
    for diag, score in res['negative'].items():
        print(indent + indent + "%s : %0.1f" % (diag, score))


def print_tracing_quality(res, indent):
    print(indent + "Tracing Quality:")
    for samp, tq in res['tracing-quality'].items():
        print(indent + indent + "%s : %d" % (samp, tq))

if __name__ == '__main__':
    if len(sys.argv) < 2:
        sys.stderr.write("Missing analysis_results.json argument!\n")         
        sys.exit(-1)  
        
    with open(sys.argv[1], 'r') as f:         
        res = json.loads( f.read() ) 

        if res['object-type'] != 'analysis-result':
            print("Unexpected return value from API server:")
            for k,v in res.items():
                print("\t%s: %s" % (k, v))
            sys.exit()

        billing_info = [ ]
        if 'invoice-id' in res['results']:
            billing_info.append("Invoice ID:" +  str(res['results']['invoice-id']))
        if 'billing-info' in res['results']:
            for k, v in res['results']['billing-info'].items():
                billing_info.append("%s: %s" % (k,str(v)))
        if len(billing_info) > 0:
            print("Billing Info:")
            for line in billing_info:
                print("\t" + line)

        if 'comment' in res['results']:
            print("Comment: " + res['results']['comment'])

        print("Attachments: %d" % (len(res['attachments'])))

        print("Results Summary:")
        print_results_summary(res['results'], "\t")
